id: org.telegram.desktop.webview
sdk: org.freedesktop.Sdk//23.08
runtime: org.telegram.desktop
runtime-version: stable
build-extension: true
appstream-compose: false
build-options:
  prefix: /app/lib/webview
  prepend-pkg-config-path: /app/lib/webview/lib/pkgconfig
  cflags: -g0 -DNDEBUG
  cxxflags: -g0 -DNDEBUG
  strip: true
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/gir-1.0
modules:
  - name: unifdef
    no-autogen: true
    make-install-args:
      - prefix=/app/lib/webview
    sources:
      - type: archive
        url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
        sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
        x-checker-data:
          type: anitya
          project-id: 5046
          url-template: https://dotat.at/prog/unifdef/unifdef-$version.tar.xz
    cleanup:
      - '*'

  - name: highway
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=None
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DHWY_ENABLE_CONTRIB=OFF
      - -DHWY_ENABLE_EXAMPLES=OFF
    sources:
      - type: archive
        url: https://github.com/google/highway/archive/1.0.7/highway-1.0.7.tar.gz
        sha256: 5434488108186c170a5e2fca5e3c9b6ef59a1caa4d520b008a9b8be6b8abe6c5
        x-checker-data:
          type: json
          url: https://api.github.com/repos/google/highway/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag
          url-query: '"https://github.com/google/highway/archive/\($tag)/highway-\($version).tar.gz"'
    cleanup:
      - '*'

  - name: libavif
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=None
      - -DAVIF_CODEC_DAV1D=ON
    sources:
      - type: archive
        url: https://github.com/AOMediaCodec/libavif/archive/v1.0.4/libavif-1.0.4.tar.gz
        sha256: dc56708c83a4b934a8af2b78f67f866ba2fb568605c7cf94312acf51ee57d146
        x-checker-data:
          type: json
          url: https://api.github.com/repos/AOMediaCodec/libavif/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag | sub("^[vV]"; "")
          url-query: '"https://github.com/AOMediaCodec/libavif/archive/\($tag)/libavif-\($version).tar.gz"'
    cleanup:
      - '*'

  - name: libjxl
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=None
      - -DBUILD_TESTING=OFF
      - -DJPEGXL_ENABLE_DEVTOOLS=OFF
      - -DJPEGXL_ENABLE_TOOLS=OFF
      - -DJPEGXL_ENABLE_JPEGLI=OFF
      - -DJPEGXL_ENABLE_DOXYGEN=OFF
      - -DJPEGXL_ENABLE_MANPAGES=OFF
      - -DJPEGXL_ENABLE_BENCHMARK=OFF
      - -DJPEGXL_ENABLE_EXAMPLES=OFF
      - -DJPEGXL_ENABLE_JNI=OFF
      - -DJPEGXL_ENABLE_SJPEG=OFF
      - -DJPEGXL_ENABLE_OPENEXR=OFF
      - -DJPEGXL_ENABLE_SKCMS=OFF
    sources:
      - type: archive
        url: https://github.com/libjxl/libjxl/archive/v0.9.2/libjxl-0.9.2.tar.gz
        sha256: bf28e411d84c50578ab74107cdd624e099313129883a43907c261e8116a11b3b
        x-checker-data:
          type: json
          url: https://api.github.com/repos/libjxl/libjxl/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag | sub("^[vV]"; "")
          url-query: '"https://github.com/libjxl/libjxl/archive/\($tag)/libjxl-\($version).tar.gz"'
    cleanup:
      - '*'

  - name: libwpe
    buildsystem: meson
    builddir: true
    config-opts:
      - --buildtype=plain
    sources:
      - type: archive
        url: https://github.com/WebPlatformForEmbedded/libwpe/releases/download/1.14.2/libwpe-1.14.2.tar.xz
        sha256: 8ae38022c50cb340c96fdbee1217f1e46ab57fbc1c8ba98142565abbedbe22ef
        x-checker-data:
          type: json
          url: https://api.github.com/repos/WebPlatformForEmbedded/libwpe/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag
          url-query: '"https://github.com/WebPlatformForEmbedded/libwpe/releases/download/\($tag)/libwpe-\($version).tar.xz"'

  - name: wpebackend-fdo
    buildsystem: meson
    builddir: true
    config-opts:
      - --buildtype=plain
    sources:
      - type: archive
        url: https://github.com/Igalia/WPEBackend-fdo/releases/download/1.14.2/wpebackend-fdo-1.14.2.tar.xz
        sha256: 93c9766ae9864eeaeaee2b0a74f22cbca08df42c1a1bdb55b086f2528e380d38
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Igalia/WPEBackend-fdo/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag
          url-query: '"https://github.com/Igalia/WPEBackend-fdo/releases/download/\($tag)/wpebackend-fdo-\($version).tar.xz"'

  - name: webkitgtk
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=None
      - -DPORT=GTK
      - -DUSE_LIBSECRET=OFF
      - -DUSE_WOFF2=OFF
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_SPELLCHECK=OFF
    sources:
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.42.5.tar.xz
        sha256: b64278c1f20b8cfdbfb5ff573c37d871aba74a1db26d9b39f74e8953fe61e749
        x-checker-data:
          type: html
          url: https://webkitgtk.org/releases/
          version-pattern: LATEST-STABLE-(\d[\.\d]+\d)
          url-template: https://webkitgtk.org/releases/webkitgtk-$version.tar.xz
      - type: shell
        commands:
          - sed -i 's@NAMES avif.h@NAMES avif/avif.h@' Source/cmake/FindAVIF.cmake
          - sed -i '/PATH_SUFFIXES avif/d' Source/cmake/FindAVIF.cmake
          - sed -i 's@${AVIF_INCLUDE_DIR}/avif.h@${AVIF_INCLUDE_DIR}/avif/avif.h@'
            Source/cmake/FindAVIF.cmake

  - name: metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - >-
        appstream-compose --origin=flatpak
        --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} ${FLATPAK_ID}
    sources:
      - type: file
        path: org.telegram.desktop.webview.metainfo.xml
